---
title: "01-data_processing"
output: html_document
date: "2025-01-03"
---

### Load libraries
```{r}
library(tidyverse)
library(readxl)
install.packages("chron")
library(chron)
library(ggplot2)
```


### Load data
```{r}
uploaded <- read.csv("data/FHL_Weather_All.csv")
twentytwo <- read_xlsx("data/2022.xlsx")
twentythree <- read_xlsx("data/2023.xlsx")
twentyfour <- read_xlsx("data/2024.xlsx")
```


### Clean up uploaded dataset
```{r}
uploaded_trim <- subset(uploaded, select = -c(Lat, Lon, Platform_ID, Time_PST, ISO_DateTime_UTC, Date_PST, Rad_tot))
uploaded_trim$ISO_DateTime_PST <- gsub("T", " ", uploaded_trim$ISO_DateTime_PST)
uploaded_trim$ISO_DateTime_PST <- as.POSIXct(uploaded_trim$ISO_DateTime_PST, format = "%Y-%m-%d %H:%M:%OS")
names(uploaded_trim)[names(uploaded_trim) == 'ISO_DateTime_PST'] <- 'Date'


```

### Clean up 2022 dataset
```{r}


twentytwo$Date <- as.POSIXct(twentytwo$Date, format = "%Y%m%d")
twentytwo$Time <- format(as.POSIXlt(twentytwo$Time, format="%H%M%S"),"%H:%M:%S")
twentytwo$Date <- as.POSIXct(paste(twentytwo$Date, twentytwo$Time), format="%Y-%m-%d %H:%M:%S")
twentytwo_clean <- subset(twentytwo, select = -c(Time))

for (i in 1:(length(twentytwo_clean$Date) - 4)) {  # Changed to `-4` so you don't go out of bounds
  # Skip rows where Date is NA
  if (is.na(twentytwo_clean$Date[i]) | is.na(twentytwo_clean$Date[i + 1])) {
    next  # Skip this iteration if there's an NA value
  }
  
  # Check for "23:45:00" and the next datetime being at "00:00:00" and additional conditions
  if ((format(twentytwo_clean$Date[i], "%H:%M:%S") == "23:45:00" && 
       format(twentytwo_clean$Date[i + 1], "%H:%M:%S") == "00:00:00" && 
       format(twentytwo_clean$Date[i + 1], "%m") == "12") ||
      (format(twentytwo_clean$Date[i], "%H:%M:%S") == "23:45:00" && 
       format(twentytwo_clean$Date[i + 1], "%H:%M:%S") == "00:00:00" && 
       format(twentytwo_clean$Date[i + 1], "%m-%d") == "11-30")) {
    # Adjust the date of the next few rows to the current day's date
    twentytwo_clean$Date[i + 1] <- twentytwo_clean$Date[i + 1] + 86400  # Add one day (86400 seconds)
    twentytwo_clean$Date[i + 2] <- twentytwo_clean$Date[i + 2] + 86400
    twentytwo_clean$Date[i + 3] <- twentytwo_clean$Date[i + 3] + 86400
    twentytwo_clean$Date[i + 4] <- twentytwo_clean$Date[i + 4] + 86400  # Add one day (86400 seconds)
  }
}

```

### Clean up annual datasets
```{r}
twentyfour_clean <- subset(twentyfour, select = -c(Time))
twentythree_clean <- subset(twentythree, select = -c(Time))

twentyfour_clean$Year <- format(twentyfour_clean$Date, format="%Y")
twentyfour_clean$Month <- format(twentyfour_clean$Date, format="%m")
twentyfour_clean <- twentyfour_clean %>%
  select(Year, Month, everything())

twentythree_clean$Year <- format(twentythree_clean$Date, format="%Y")
twentythree_clean$Month <- format(twentythree_clean$Date, format="%m")
twentythree_clean <- twentythree_clean %>%
  select(Year, Month, everything())

twentytwo_clean$Year <- format(twentytwo_clean$Date, format="%Y")
twentytwo_clean$Month <- format(twentytwo_clean$Date, format="%m")
twentytwo_clean <- twentytwo_clean %>%
  select(Year, Month, everything())

uploaded_trim$Month <- format(uploaded_trim$Date, format="%m")
uploaded_trim <- uploaded_trim %>%
  select(Year, Month, everything())
```


### Make columns structurally compatible
```{r}
# Convert Year column to character in all dataframes
uploaded_trim$Year <- as.character(uploaded_trim$Year)
twentytwo_clean$Year <- as.character(twentytwo_clean$Year)
twentythree_clean$Year <- as.character(twentythree_clean$Year)
twentyfour_clean$Year <- as.character(twentyfour_clean$Year)
```

```{r}
# Convert Rad_PAR column to numeric (double) in all dataframes
uploaded_trim$Rad_PAR <- as.numeric(uploaded_trim$Rad_PAR)
twentytwo_clean$Rad_PAR <- as.numeric(twentytwo_clean$Rad_PAR)
twentythree_clean$Rad_PAR <- as.numeric(twentythree_clean$Rad_PAR)
twentyfour_clean$Rad_PAR <- as.numeric(twentyfour_clean$Rad_PAR)

```

```{r}
# Convert Rad_Energy column to numeric (double) in all dataframes
uploaded_trim$Rad_Energy <- as.numeric(uploaded_trim$Rad_Energy)
twentytwo_clean$Rad_Energy <- as.numeric(twentytwo_clean$Rad_Energy)
twentythree_clean$Rad_Energy <- as.numeric(twentythree_clean$Rad_Energy)
twentyfour_clean$Rad_Energy <- as.numeric(twentyfour_clean$Rad_Energy)

```

```{r}
# Convert Wind_speed column to numeric (double) in all dataframes
uploaded_trim$Wind_speed <- as.numeric(uploaded_trim$Wind_speed)
twentytwo_clean$Wind_speed <- as.numeric(twentytwo_clean$Wind_speed)
twentythree_clean$Wind_speed <- as.numeric(twentythree_clean$Wind_speed)
twentyfour_clean$Wind_speed <- as.numeric(twentyfour_clean$Wind_speed)

```


```{r}
### Convert wind chill to numeric
uploaded_trim$Wind_Chill <- as.numeric(uploaded_trim$Wind_Chill)
twentytwo_clean$Wind_Chill <- as.numeric(twentytwo_clean$Wind_Chill)
twentythree_clean$Wind_Chill <- as.numeric(twentythree_clean$Wind_Chill)
twentyfour_clean$Wind_Chill <- as.numeric(twentyfour_clean$Wind_Chill)
```

### Combine yearly datasets
```{r}
weather <- bind_rows(uploaded_trim, twentytwo_clean, twentythree_clean, twentyfour_clean)

weather$Month <- format(weather$Date, format="%m")
weather$Year <- format(weather$Date, format="%Y")

weather_clean_unique <- weather[!duplicated(weather$Date), ]
```

### Graphs
```{r}
ggplot(weather_clean_unique, aes(x=Year, y= Wind_Chill, fill = Year))+
  geom_violin()+
  theme_classic()+
  ylab("Wind Chill (Â°C)")+
  geom_hline(yintercept = 10)+
  theme(axis.title = element_text(size=20, color = "black"),
        axis.text = element_text(size=18, color = "black"))
  
```


```{r}
ggplot(weather_clean_unique, aes(x=Date, y = Rad_PAR))+
  geom_point()+
  theme_classic()
```

```{r}
ggplot(weather_clean_unique, aes(x=Date, y = Rad_Energy))+
  geom_point()+
  theme_classic()
```


